name: Publish Example Image

on:
  workflow_call:
    inputs:
      builder_tag:
        description: The tag of the builder image to use
        type: string
        default: latest
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  EXAMPLE_IMAGE: ${{ github.repository }}-example

jobs:
  build-example:
    runs-on: ubuntu-latest
    env:
      BUILDER_IMAGE: ghcr.io/${{ github.repository }}-builder:${{ inputs.builder_tag || 'latest' }}
      NIX_BINARY_CACHE_DIR: /root/.cache/nix/store
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Nix store directories
        run: |
          mkdir -p ${{ runner.temp }}/nix-cache

      - name: Restore Nix store cache
        uses: actions/cache@v4
        with:
          path: |
            ${{ runner.temp }}/nix-cache
          key: v2-nix-store-example-${{ hashFiles('example/devbox.json', 'example/devbox.lock') }}
          restore-keys: |
            v2-nix-store-example-

      - name: Build example using the builder
        run: |
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -v ${{ github.workspace }}/example:/project \
            -v ${{ runner.temp }}/nix-cache:/root/.cache/nix \
            ${{ env.BUILDER_IMAGE }} \
            --name ${{ env.REGISTRY }}/${{ env.EXAMPLE_IMAGE }} \
            --tag latest

      - name: Verify example image
        run: |
          docker run --rm ${{ env.REGISTRY }}/${{ env.EXAMPLE_IMAGE }}:latest yq --version
          docker run --rm ${{ env.REGISTRY }}/${{ env.EXAMPLE_IMAGE }}:latest curl --version | head -1

      - name: Fix cache permissions
        if: always()
        run: |
          sudo chown -R $(id -u):$(id -g) ${{ runner.temp }}/nix-cache

      - name: Push example image
        run: |
          docker push ${{ env.REGISTRY }}/${{ env.EXAMPLE_IMAGE }}:latest
