name: Test GHA Container Compatibility

on:
  workflow_call:
  workflow_dispatch:

jobs:
  # Build and push the example image for testing
  build-test-image:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image_tag: ghcr.io/${{ github.repository }}/gha-compat-test:${{ github.sha }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build builder image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          load: true
          tags: devbox-nix-builder:test
          platforms: linux/amd64

      - name: Build example image
        run: |
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -v ${{ github.workspace }}/example:/project \
            devbox-nix-builder:test \
            --name ghcr.io/${{ github.repository }}/gha-compat-test --tag ${{ github.sha }}

      - name: Push test image
        run: docker push ghcr.io/${{ github.repository }}/gha-compat-test:${{ github.sha }}

  # Test using the container: directive with actions/checkout
  test-in-container:
    needs: build-test-image
    runs-on: ubuntu-latest
    container:
      image: ${{ needs.build-test-image.outputs.image_tag }}
    steps:
      # This is THE critical test - if actions/checkout works,
      # the dynamic linker fix is working because GHA's Node.js runs
      - name: Checkout (tests GHA Node.js compatibility)
        uses: actions/checkout@v4

      - name: Verify devbox packages work
        run: |
          echo "==> Testing yq..."
          yq --version
          echo "==> Testing curl..."
          curl --version | head -1
          echo "==> Checking /lib64 symlink..."
          ls -la /lib64/ || echo "No /lib64"
          echo "==> SUCCESS: Container is GHA-compatible!"
